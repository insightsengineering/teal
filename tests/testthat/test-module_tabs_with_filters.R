filtered_data <- teal.slice:::FilteredData$new()
filtered_data$set_dataset(teal.data::dataset(dataname = "iris", x = head(iris)))
filtered_data$set_dataset(teal.data::dataset(dataname = "mtcars", x = head(mtcars)))

test_module1 <- module(
  label = "iris tab",
  ui = function(id, ...) NULL,
  server = function(id, datasets) moduleServer(id, function(input, output, session) message("1")),
  filters = "iris"
)

test_module2 <- module(
  label = "mtcars tab",
  ui = function(id, ...) NULL,
  server = function(id, datasets) moduleServer(id, function(input, output, session) message("2")),
  filters = "mtcars"
)

test_module3 <- module(
  label = "mtcars tab2",
  ui = function(id, ...) NULL,
  server = function(id, datasets) moduleServer(id, function(input, output, session) message("3")),
  filters = "mtcars"
)

testthat::test_that("srv_tabs_with_filters throws error if reporter is not of class Reporter", {
  testthat::expect_error(
    srv_tabs_with_filters(id, datasets = filtered_data, modules = modules(test_module1), reporter = list()),
    "Assertion on 'reporter' failed"
  )
})

testthat::test_that("passed shiny module is initialized when its tab is activated (clicked)", {
  testthat::expect_message(
    shiny::testServer(
      app = srv_tabs_with_filters,
      args = list(
        id = "test",
        datasets = filtered_data,
        modules = modules(test_module3),
        filter = list(),
        reporter = teal.reporter::Reporter$new()
      ),
      expr = {
        session$setInputs(`root-active_tab` = "mtcars_tab")
      }
    ),
    "3"
  )
})

testthat::test_that("passed shiny modules are initialized when their tab is activated (clicked)", {
  out <- testthat::capture_messages(
    shiny::testServer(
      app = srv_tabs_with_filters,
      args = list(
        id = "test",
        datasets = filtered_data,
        modules = modules(test_module1, test_module2, test_module3),
        filter = list(),
        reporter = teal.reporter::Reporter$new()
      ),
      expr = {
        session$setInputs(`root-active_tab` = "iris_tab")
        session$setInputs(`root-active_tab` = "mtcars_tab")
        session$setInputs(`root-active_tab` = "mtcars_tab2")
      }
    )
  )
  testthat::expect_identical(out, c("1\n", "2\n", "3\n"))
})

testthat::test_that("active_datanames() returns dataname from single tab", {
  shiny::testServer(
    app = srv_tabs_with_filters,
    args = list(
      id = "test",
      datasets = filtered_data,
      modules = modules(test_module1),
      filter = list(),
      reporter = teal.reporter::Reporter$new()
    ),
    expr = {
      session$setInputs(`root-active_tab` = "iris_tab")
      testthat::expect_identical(active_datanames(), "iris")
    }
  )
})

testthat::test_that("active_datanames() returns dataname from active tab after change", {
  shiny::testServer(
    app = srv_tabs_with_filters,
    args = list(
      id = "test",
      datasets = filtered_data,
      modules = modules(test_module1, test_module2),
      filter = list(),
      reporter = teal.reporter::Reporter$new()
    ),
    expr = {
      testthat::expect_error(active_datanames())
      session$setInputs(`root-active_tab` = "iris_tab")
      testthat::expect_identical(active_datanames(), "iris")
      session$setInputs(`root-active_tab` = "mtcars_tab")
      testthat::expect_identical(active_datanames(), "mtcars")
    }
  )
})
