<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Filter state snapshot management — module_snapshot_manager • teal</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Filter state snapshot management — module_snapshot_manager"><meta name="description" content="Capture and restore snapshots of the global (app) filter state."><meta property="og:description" content="Capture and restore snapshots of the global (app) filter state."><link rel="stylesheet" href="../consent.css"><script src="../consent.js" type="text/javascript" charset="utf-8"></script></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">teal</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.15.2.9084</small>

    <div style="width: 140px; margin-left: 0.5rem;"> <small class="nav-text text-muted me-auto">part of</small> <img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/nest.png?raw=true" alt="NEST" style="height: 30px;"><a href="https://pharmaverse.org/" class="external-link"><img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/pharmaverse.png?raw=true" alt="pharmaverse" style="height: 28px;"></a> </div>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/getting-started-with-teal.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Get started</h6></li>
    <li><a class="dropdown-item" href="../articles/getting-started-with-teal.html">Getting Started with teal</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Using `teal`</h6></li>
    <li><a class="dropdown-item" href="../articles/filter-panel.html">Filter Panel</a></li>
    <li><a class="dropdown-item" href="../articles/teal-options.html">Modifying a teal Application With R Options</a></li>
    <li><a class="dropdown-item" href="../articles/bootstrap-themes-in-teal.html">Bootstrap Themes in teal</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Data in `teal` apps</h6></li>
    <li><a class="dropdown-item" href="../articles/including-data-in-teal-applications.html">Including Data in teal Applications</a></li>
    <li><a class="dropdown-item" href="../articles/data-as-shiny-module.html">Data as shiny Module</a></li>
    <li><a class="dropdown-item" href="../articles/data-transform-as-shiny-module.html">Data Transformations as shiny Module</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Extending `teal`</h6></li>
    <li><a class="dropdown-item" href="../articles/creating-custom-modules.html">Creating Custom Modules</a></li>
    <li><a class="dropdown-item" href="../articles/adding-support-for-reporting.html">Adding Support for Reporting to Custom Modules</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-technical-blueprint" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Technical blueprint</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-technical-blueprint"><li><a class="dropdown-item" href="../articles/blueprint/index.html">About blueprint</a></li>
    <li><a class="dropdown-item" href="../articles/blueprint/intro.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/blueprint/actors.html">Actors</a></li>
    <li><a class="dropdown-item" href="../articles/blueprint/dataflow.html">Data flow</a></li>
    <li><a class="dropdown-item" href="../articles/blueprint/product_map.html">Product map</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Features</h6></li>
    <li><a class="dropdown-item" href="../articles/blueprint/input_data.html">Input data</a></li>
    <li><a class="dropdown-item" href="../articles/blueprint/in_app_data.html">In-app data</a></li>
    <li><a class="dropdown-item" href="../articles/blueprint/filter_panel.html">Filter panel</a></li>
    <li><a class="dropdown-item" href="../articles/blueprint/module_encapsulation.html">Module and encapsulation</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-reports" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Reports</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-reports"><li><a class="dropdown-item" href="../coverage-report/">Coverage report</a></li>
    <li><a class="dropdown-item" href="../unit-test-report/">Unit test report</a></li>
    <li><a class="dropdown-item" href="../unit-test-report-non-cran/">Non-CRAN unit test report</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/insightsengineering/teal" aria-label="View on Github"><span class="fa fa-github"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Filter state snapshot management</h1>
      <small class="dont-index">Source: <a href="https://github.com/insightsengineering/teal/blob/main/R/module_snapshot_manager.R" class="external-link"><code>R/module_snapshot_manager.R</code></a></small>
      <div class="d-none name"><code>module_snapshot_manager.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Capture and restore snapshots of the global (app) filter state.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">ui_snapshot_manager_panel</span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">srv_snapshot_manager_panel</span><span class="op">(</span><span class="va">id</span>, <span class="va">slices_global</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ui_snapshot_manager</span><span class="op">(</span><span class="va">id</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">srv_snapshot_manager</span><span class="op">(</span><span class="va">id</span>, <span class="va">slices_global</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-id">id<a class="anchor" aria-label="anchor" href="#arg-id"></a></dt>
<dd><p>(<code>character(1)</code>) <code>shiny</code> module instance id.</p></dd>


<dt id="arg-slices-global">slices_global<a class="anchor" aria-label="anchor" href="#arg-slices-global"></a></dt>
<dd><p>(<code>reactiveVal</code>) that contains a <code>teal_slices</code> object
containing all <code>teal_slice</code>s existing in the app, both active and inactive.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p><code>list</code> containing the snapshot history, where each element is an unlisted <code>teal_slices</code> object.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This module introduces snapshots: stored descriptions of the filter state of the entire application.
Snapshots allow the user to save the current filter state of the application for later use in the session,
as well as to save it to file in order to share it with an app developer or other users,
who in turn can upload it to their own session.</p>
<p>The snapshot manager is accessed with the camera icon in the tabset bar.
At the beginning of a session it presents three icons: a camera, an upload, and an circular arrow.
Clicking the camera captures a snapshot, clicking the upload adds a snapshot from a file
and applies the filter states therein, and clicking the arrow resets initial application state.
As snapshots are added, they will show up as rows in a table and each will have a select button and a save button.</p>
    </div>
    <div class="section level2">
    <h2 id="server-logic">Server logic<a class="anchor" aria-label="anchor" href="#server-logic"></a></h2>


<p>Snapshots are basically <code>teal_slices</code> objects, however, since each module is served by a separate instance
of <code>FilteredData</code> and these objects require shared state, <code>teal_slice</code> is a <code>reactiveVal</code> so <code>teal_slices</code>
cannot be stored as is. Therefore, <code>teal_slices</code> are reversibly converted to a list of lists representation
(attributes are maintained).</p>
<p>Snapshots are stored in a <code>reactiveVal</code> as a named list.
The first snapshot is the initial state of the application and the user can add a snapshot whenever they see fit.</p>
<p>For every snapshot except the initial one, a piece of UI is generated that contains
the snapshot name, a select button to restore that snapshot, and a save button to save it to a file.
The initial snapshot is restored by a separate "reset" button.
It cannot be saved directly but a user is welcome to capture the initial state as a snapshot and save that.</p>
    </div>
    <div class="section level2">
    <h2 id="snapshot-mechanics">Snapshot mechanics<a class="anchor" aria-label="anchor" href="#snapshot-mechanics"></a></h2>


<p>When a snapshot is captured, the user is prompted to name it.
Names are displayed as is but since they are used to create button ids,
under the hood they are converted to syntactically valid strings.
New snapshot names are validated so that their valid versions are unique.
Leading and trailing white space is trimmed.</p>
<p>The module can read the global state of the application from <code>slices_global</code> and <code>mapping_matrix</code>.
The former provides a list of all existing <code>teal_slice</code>s and the latter says which slice is active in which module.
Once a name has been accepted, <code>slices_global</code> is converted to a list of lists - a snapshot.
The snapshot contains the <code>mapping</code> attribute of the initial application state
(or one that has been restored), which may not reflect the current one,
so <code>mapping_matrix</code> is transformed to obtain the current mapping, i.e. a list that,
when passed to the <code>mapping</code> argument of <code><a href="teal_slices.html">teal_slices()</a></code>, would result in the current mapping.
This is substituted as the snapshot's <code>mapping</code> attribute and the snapshot is added to the snapshot list.</p>
<p>To restore app state, a snapshot is retrieved from storage and rebuilt into a <code>teal_slices</code> object.
Then state of all <code>FilteredData</code> objects (provided in <code>datasets</code>) is cleared
and set anew according to the <code>mapping</code> attribute of the snapshot.
The snapshot is then set as the current content of <code>slices_global</code>.</p>
<p>To save a snapshot, the snapshot is retrieved and reassembled just like for restoring,
and then saved to file with <code><a href="slices_store.html">slices_store()</a></code>.</p>
<p>When a snapshot is uploaded, it will first be added to storage just like a newly created one,
and then used to restore app state much like a snapshot taken from storage.
Upon clicking the upload icon the user will be prompted for a file to upload
and may choose to name the new snapshot. The name defaults to the name of the file (the extension is dropped)
and normal naming rules apply. Loading the file yields a <code>teal_slices</code> object,
which is disassembled for storage and used directly for restoring app state.</p>
    </div>
    <div class="section level2">
    <h2 id="transferring-snapshots">Transferring snapshots<a class="anchor" aria-label="anchor" href="#transferring-snapshots"></a></h2>


<p>Snapshots uploaded from disk should only be used in the same application they come from,
<em>i.e.</em> an application that uses the same data and the same modules.
To ensure this is the case, <code>init</code> stamps <code>teal_slices</code> with an app id that is stored in the <code>app_id</code> attribute of
a <code>teal_slices</code> object. When a snapshot is restored from file, its <code>app_id</code> is compared to that
of the current app state and only if the match is the snapshot admitted to the session.</p>
    </div>
    <div class="section level2">
    <h2 id="bookmarks">Bookmarks<a class="anchor" aria-label="anchor" href="#bookmarks"></a></h2>


<p>An <code>onBookmark</code> callback creates a snapshot of the current filter state.
This is done on the app session, not the module session.
(The snapshot will be retrieved by <code>module_teal</code> in order to set initial app state in a restored app.)
Then that snapshot, and the previous snapshot history are dumped into the <code>values.rds</code> file in <code>&lt;bookmark_dir&gt;</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Aleksander Chlebowski</p>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="nest">
  <p>teal is a part of the <strong>NEST</strong> and <a href="https://pharmaverse.org/" class="external-link"><strong>pharmaverse</strong></a>.</p>
</div>
<script type="text/javascript" src="../analytics.js"></script></footer></div>





  </body></html>

