---
title: "Data Transform as shiny Module"
author: "NEST CoreDev"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Data Transform as shiny Module}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

The input data supplied by the app developer in the `data` argument of the `init` function is passed through the filter panel and the filtered data is supplied to the all modules.
It is important to note that the filter panel only performs one kind of computation on the datasets, it filters the data based on the user interaction.
However, there are use cases where we need to provide a more customized transformation options for the app user.
Historically, customised data transformations was achieved in the teal apps using the encoding panel, where the module developer provides custom UI and server logic for the data transformation.
But, with the new `teal_transform_module` function, it is now possible to provide a more dynamic transformation capability which can be customised by the app developer and not just the module developer.

The `teal_transform_module()` function can be used to create a `teal_data_module` object that is basically a shiny module where the module server function takes in the data from the filter panel and returns the data after applying the custom transformation logic.

## Creating your first custom data transformation module

We initialize a simple teal app where we pass `iris` and `mtcars` as the input datasets.

```{r, message = FALSE, warning = FALSE}
library(teal)
```

```{r}
data <- teal_data() %>%
  within({
    iris <- iris
    mtcars <- mtcars
  })


app <- init(
  data = data,
  modules = example_module()
)

if (interactive()) {
  shinyApp(app$ui, app$server)
}
```

Lets create a simple `teal_transform_module` that returns the first n number of rows of `iris` based on the user input.

We do this by creating the `ui` with the `numericInput` for the user to input the number of rows to be displayed.
In the `server` function we take in the reactive `data` and perform this transformation and return the new reactive `data`.

```{r}
library(teal)
data <- teal_data() %>%
  within({
    iris <- iris
    mtcars <- mtcars
  })

my_transformers <- list(
  teal_transform_module(
    label = "Custom transform for iris",
    ui = function(id) {
      ns <- NS(id)
      tags$div(
        numericInput(ns("n_rows"), "Number of rows to subset", value = 6, min = 1, max = 150, step = 1)
      )
    },
    server = function(id, data) {
      moduleServer(id, function(input, output, session) {
        reactive({
          data() %>%
            within(
              {
                iris <- head(iris, num_rows)
              },
              num_rows = input$n_rows
            )
        })
      })
    }
  )
)

app <- init(
  data = data,
  modules = example_module(transformers = my_transformers)
)

if (interactive()) {
  shinyApp(app$ui, app$server)
}
```

Note that we can add multiple teal transforms by adding calling `teal_transform_module` in a list and passing the list of teal transforms to the `transformers` argument of the module call.

Lets add another transformation to the `mtcars` dataset to create a column with the `rownames` of `mtcars`.
Also, note that this module does not have interactive UI elements.

```{r}
library(teal)
data <- teal_data() %>%
  within({
    iris <- iris
    mtcars <- mtcars
  })

my_transformers <- list(
  teal_transform_module(
    label = "Custom transform for iris",
    ui = function(id) {
      ns <- NS(id)
      tags$div(
        numericInput(ns("n_rows"), "Number of rows to subset", value = 6, min = 1, max = 150, step = 1)
      )
    },
    server = function(id, data) {
      moduleServer(id, function(input, output, session) {
        reactive({
          data() %>%
            within(
              {
                iris <- head(iris, num_rows)
              },
              num_rows = input$n_rows
            )
        })
      })
    }
  ),
  teal_transform_module(
    label = "Custom transform for mtcars",
    ui = function(id) {
      ns <- NS(id)
      tags$div(
        "Adding rownames column to mtcars"
      )
    },
    server = function(id, data) {
      moduleServer(id, function(input, output, session) {
        reactive({
          data() %>%
            within({
              mtcars$rownames <- rownames(mtcars)
              rownames(mtcars) <- NULL
            })
        })
      })
    }
  )
)

app <- init(
  data = data,
  modules = example_module(transformers = my_transformers)
)

if (interactive()) {
  shinyApp(app$ui, app$server)
}
```

## Custom placement of the transform UI

When a custom transformation is used, the UI for the transformation is placed below the filter panel.
However, there is a way to customize the placement of the UI inside the module content.

This can only be done when the module allocates a dedicated space for the transform UI.

Let's create a custom module that has a dedicated space for the transform UI inside the module content.
