---
title: "Developer Apps"
author: "Maximilian Mordig"
date: "18/06/2020"
output: rmarkdown::html_vignette
editor_options:
  chunk_output_type: console
vignette: >
  %\VignetteIndexEntry{Developer Apps}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This vignette provides apps for the developer to check that functionality still works. It uses debugging modules and
these should not be deleted. Eventually, Shiny tests for these modules should be developed.

We load the libraries and set relevant options. Be careful to load the development version of `teal` when developing.

```{r loadLibraries, eval=FALSE}
# execute the vignette as if it were executed interactively
# when you run KnitR from RStudio, it does not run the vignette interactively
execute_like_interactive <- interactive()
# execute_like_interactive <- TRUE # only for developing, automation should not run apps #nolint

# load the development version of teal if you have not installed it
load_dev_teal <- execute_like_interactive
if (load_dev_teal) {
  # obfuscated call to avoid dependence on devtools required by R CMD CHECK
  do.call(`::`, list(quote(devtools), quote(load_all)))()
} else {
  cat("Loading non-dev version.\n")
  library(teal)
}


# Don't remove these options, the developer may activate them as needed
options(shiny.fullstacktrace = TRUE) # to show a detailed stack trace, see `?getShinyOption()`
# where to open app (new window or within RStudio)
# options("shiny.launch.browser" = TRUE) # to open a new window #nolint
# to open in RStudio Viewer pane, only available in RStudio, so it won't go through `CI` if enabled
# options("shiny.launch.browser" = function(url) invisible(.Call("rs_shinyviewer", url, getwd(), 2)))  #nolint
# to evaluate reactives without taking dependencies, implicitly wrap them into an `isolate` context
# options("shiny.suppressMissingContextError" = FALSE) #nolint

# to make it easy for the developer to toggle it on
safeBookmarkableShinyApp <- function(..., execute_app = execute_like_interactive) { # nolint
  if (execute_app) {
    bookmarkableShinyApp(...)
  } else {
    cat("Not executing Shiny app.\n")
  }
}
```

```{r createDatasets, eval=FALSE}
# Create the datasets

# nolint start
ADSL <- data.frame(
  STUDYID = "ABC123",
  USUBJID = factor(1:100),
  AGE = rep(c(34, 43, 23, 34), 25),
  SEX = rep(c("M", "F", NA, "F"), 25),
  COUNTRY = rep(c("USA", "BRAZIL"), 50),
  logical_test = rep(c(TRUE, FALSE, NA, TRUE, 25))
)

ADSL_code <- 'ADSL <- data.frame(
  STUDYID = "ABC123",
  USUBJID = factor(1:100),
  AGE = rep(c(34, 43, 23, 34), 25),
  SEX = rep(c("M", "F", NA, "F"), 25),
  COUNTRY = rep(c("USA", "BRAZIL"), 50),
  logical_test = rep(c(TRUE, FALSE, NA, TRUE, 25))
)'


ADAE <- rbind(ADSL, ADSL)
ADAE$ASTDTM <- as.Date(18586:18785, origin = "1970-01-01")
ADAE$AETERM <- rep(c(
  "trm A.1.1.1.1",
  "trm A.1.1.1.2",
  "trm B.1.1.1.1",
  "trm B.2.1.2.1",
  "trm B.2.2.3.1",
  "trm C.1.1.1.3",
  "trm C.2.1.2.1",
  "trm D.1.1.1.1"
), 25)
ADAE$AESEQ <- rep(1:10, 20)

ADAE_code <- 'ADAE <- rbind(ADSL, ADSL)
ADAE$ASTDTM <- as.Date(18586:18785, origin = "1970-01-01")
ADAE$AETERM <- rep(c("trm A.1.1.1.1",
                 "trm A.1.1.1.2",
                 "trm B.1.1.1.1",
                 "trm B.2.1.2.1",
                 "trm B.2.2.3.1",
                 "trm C.1.1.1.3",
                 "trm C.2.1.2.1",
                 "trm D.1.1.1.1"), 25)
ADAE$AESEQ <- rep(1:10, 20)'


ADLB <- rbind(ADSL, ADSL)
ADLB$PARAMCD <- rep(paste0("ALT", 1:8), 25)
ADLB$AVISIT <- rep(c("SCREENING", "BASELINE", "WEEK 1 DAY 8", "WEEK 2 DAY 15"), 50)
ADLB$ASEQ <- rep(1:20, 10)

ADLB_code <- 'ADLB <- rbind(ADSL, ADSL)
ADLB$PARAMCD <- rep(paste0("ALT", 1:8), 25)
ADLB$AVISIT <- rep(c("SCREENING", "BASELINE", "WEEK 1 DAY 8", "WEEK 2 DAY 15"), 50)
ADLB$ASEQ <-  rep(1:20, 10)'

# nolint end
adsl <- cdisc_dataset(dataname = "ADSL", x = ADSL, code = ADSL_code)
adae <- cdisc_dataset(dataname = "ADAE", x = ADAE, code = ADAE_code, vars = list(ADSL = adsl))
adlb <- cdisc_dataset(dataname = "ADLB", x = ADLB, code = ADLB_code, vars = list(ADSL = adsl))
```

# Apps

Don't forget to reload the app when you change code. The fastest is
```
devtools::load_all("../teal")
```
or the keyboard shortcut `^ + Shift + L` on a Mac.

We use `safeBookmarkableShinyApp` instead of `shinyApp` to allow bookmarking. It wraps the UI function into a function with one
argument for the request object. We further wrap it to only execute it when the option is enabled.

You can execute these apps in any order.

## Main Debugging App

This is the main debugging app to check that the functionality still works after code changes:
```{r mainDebugApp, eval=FALSE}
library(teal)

app <- init(
  data = cdisc_data(
    adsl, adae, adlb,
    check = TRUE
  ),
  modules = root_modules(
    teal:::filter_calls_module(),
    teal:::reset_filters_module("Reset", active_datanames = c("ADSL", "ADLB"))
  ),
  filter = list(
    ADSL = list(SEX = list("M", keep_na = TRUE), AGE = default_filter()),
    ADLB = list(ASEQ = list(c(5.6, 20), keep_na = FALSE))
  ),
  header = "App with Debugging Modules",
  footer = tags$p(class = "text-muted", "Source: agile-R website")
)
safeBookmarkableShinyApp(app$ui, app$server, enableBookmarking = "url")
```

## Lazy Filtering of Datasets

The datasets are lazily filtered meaning that when they are not needed for the current tab (as specified with `active_datanames`), they will simply not be refiltered. You can check this by modifying the filters of `ADSL` in a tab without `ADAE`. Then, the console should print that `ADSL` is refiltered, but not `ADAE`. Other datasets the tab depends on like `ADLB` will be refiltered.

```{r lazyFilteringApp, eval=FALSE}
app <- init(
  data = cdisc_data(
    adsl, adae, adlb
  ),
  modules = root_modules(
    teal:::filter_calls_module("ADAE", active_datanames = c("ADAE")),
    teal:::filter_calls_module("ADSL", active_datanames = c("ADSL")),
    teal:::filter_calls_module("ADLB", active_datanames = c("ADLB"))
  ),
  filter = list(
    ADSL = list(
      SEX = list("M", keep_na = TRUE),
      COUNTRY = c("USA", NA),
      AGE = default_filter()
    )
  ),
  header = "Data is Lazily Filtered",
  footer = tags$p(class = "text-muted", "Source: agile-R website")
)
safeBookmarkableShinyApp(app$ui, app$server, enableBookmarking = "url")
```

## App with Delayed Data

This app tests that the app works with delayed data that is not available initially and loaded after the splash screen is submitted. Then, the splash UI is replaced by the main teal UI.

```{r delayedDataApp, eval=FALSE}
app <- init(
  data = cdisc_data(
    code_cdisc_dataset_connector("ADSL", code = adsl_code)
  ),
  modules = root_modules(
    teal:::filter_calls_module("ADSL", active_datanames = c("ADSL"))
  ),
  filter = list(
    ADSL = list(
      SEX = list("M", keep_na = TRUE),
      COUNTRY = c("USA", NA),
      AGE = default_filter()
    )
  ),
  header = "App with Delayed Data",
  footer = tags$p(class = "text-muted", "Source: agile-R website")
)
safeBookmarkableShinyApp(app$ui, app$server, enableBookmarking = "url")
```

## Nested Modules

This app shows nested modules and how the filters apply to them. Check the tab hierarchy `A1 -> B1.3`.
```{r nestedModulesApp, eval=FALSE}
app <- init(
  data = cdisc_data(
    adsl, adae, adlb
  ),
  modules = root_modules(
    modules(
      label = "A1",
      teal:::filter_calls_module("B1.1", active_datanames = c("ADSL", "ADAE")),
      teal:::filter_calls_module("B1.2"),
      modules(
        label = "B1.3",
        teal:::filter_calls_module("C1.1", active_datanames = c("ADSL", "ADAE")),
        teal:::filter_calls_module("C1.2")
      )
    ),
    modules(label = "A2", teal:::filter_calls_module("D2", active_datanames = c("ADSL")))
  ),
  filter = list(
    ADSL = list(
      SEX = list("M", keep_na = TRUE),
      COUNTRY = c("USA", NA),
      AGE = default_filter()
    )
  ),
  header = "Modules in Nested Tabs",
  footer = tags$p(class = "text-muted", "Source: agile-R website")
)
safeBookmarkableShinyApp(app$ui, app$server, enableBookmarking = "url")
```

## Different Ways to Specify the Initial Filter States

We show different ways of how to specify the initial filter states.
To show this, we generate fake data. We implicitly also check that the code works without the usual key `STUDYID`.

```{r initialFilterStatesApp, eval=FALSE}
fake_data <- data.frame(
  USUBJID = 1:9,
  SEX1 = c("F", "F", "F", "M", "M", "M", "F", "M", NA_character_),
  SEX2 = c("F", "F", "F", "M", "M", "M", "F", "M", NA_character_),
  SEX3 = c("F", "F", "F", "M", "M", "M", "F", "M", NA_character_),
  SEX4 = c("F", "F", "F", "M", "M", "M", "F", "M", NA_character_),
  SEX5 = c("F", "F", "F", "M", "M", "M", "F", "M", NA_character_),
  stringsAsFactors = FALSE
)

data <- cdisc_data(
  cdisc_dataset(
    dataname = "ADSL",
    x = fake_data,
    keys = "USUBJID"
  )
)

app <- init(
  data = data,
  modules = root_modules(
    teal:::filter_calls_module()
  ),
  filter = list(
    ADSL = list(
      SEX1 = c("M"),
      SEX2 = c("M", NA),
      SEX3 = list("M"),
      SEX4 = list("M", keep_na = TRUE),
      SEX5 = default_filter()
    )
  ),
  header = "Different Ways to Specify Initial Filter States",
  footer = tags$p(class = "text-muted", "Source: agile-R website")
)
safeBookmarkableShinyApp(app$ui, app$server, enableBookmarking = "url")
```

## Dataset Not Provided But Still Referred To

This app shows what happens when a dataset, `ADAE`, is not provided, but still appears in the `active_datanames`. A warning is displayed to the console.

```{r nonProvidedDataset, eval=FALSE}
app <- init(
  data = cdisc_data(
    cdisc_dataset(dataname = "ADSL", x = ADSL, code = "ADSL <- rcd_2021_07_07$adsl"),
    cdisc_dataset(dataname = "ADLB", x = ADLB, code = "ADLB <- rcd_2021_07_07$adlb")
  ),
  modules = root_modules(
    teal:::filter_calls_module("ADAE", active_datanames = c("ADAE")),
    teal:::filter_calls_module("ADSL", active_datanames = c("ADSL"))
  ),
  header = "Missing ADAE Dataset Raises Warning",
  footer = tags$p(class = "text-muted", "Source: agile-R website")
)
safeBookmarkableShinyApp(app$ui, app$server, enableBookmarking = "url")
```


## Apply several filters at once

This app checks that several filters can be applied at once. The logic is non-trivial. For instance, one can define a safety filter.

```{r predefinedFiltersApp, eval=FALSE}
# dummy filter to show how several filters can be applied at once, not sensible
safety_filter <- list(
  ADSL = list(SEX = list(choices = "M", keep_na = TRUE), AGE = default_filter()),
  ADLB = list(ASEQ = default_filter())
)
app <- init(
  data = cdisc_data(
    cdisc_dataset(dataname = "ADSL", x = ADSL, code = "ADSL <- rcd_2021_07_07$adsl"),
    cdisc_dataset(dataname = "ADAE", x = ADAE, code = "ADAE <- rcd_2021_07_07$adae"),
    cdisc_dataset(dataname = "ADLB", x = ADLB, code = "ADLB <- rcd_2021_07_07$adlb")
  ),
  modules = root_modules(
    teal:::predefined_filters_module(filter = safety_filter),
    teal:::filter_calls_module()
  ),
  filter = list(
    ADSL = list(
      SEX = list("M", keep_na = TRUE),
      COUNTRY = c("USA", NA),
      AGE = default_filter()
    ),
    ADAE = list(
      AEHLT = default_filter()
    )
  ),
  header = "Start with Pre-defined Filters",
  footer = tags$p(class = "text-muted", "Source: agile-R website")
)
safeBookmarkableShinyApp(app$ui, app$server, enableBookmarking = "url")
```



## Module with Hidden Filter

This app tests that the right filter panel can be hidden.

```{r hiddenFilterApp, eval=FALSE}
module_hidden_filters <- teal:::module(
  label = "Hidden Filters",
  server = function(input, output, session, datasets) {
  },
  ui = function(id, ...) {
    p("There should be no right filter panel.")
  },
  filters = NULL # hide filter panel
)
app <- init(
  data = cdisc_data(
    cdisc_dataset(dataname = "ADSL", x = ADSL, code = "ADSL <- rcd_2021_07_07$adsl"),
    cdisc_dataset(dataname = "ADLB", x = ADLB, code = "ADLB <- rcd_2021_07_07$adlb")
  ),
  modules = root_modules(
    module_hidden_filters,
    teal:::filter_calls_module()
  ),
  header = "Hidden Right Filter Panel",
  footer = tags$p(class = "text-muted", "Source: agile-R website")
)
safeBookmarkableShinyApp(app$ui, app$server, enableBookmarking = "url")
```


## Raw App with Hardly Anything

This app purely tests the modules, it only has one tab and two datasets. It can be used to check that all labels are preserved and shown in the UI.

```{r rawApp, eval=FALSE}
app <- init(
  data = cdisc_data(
    cdisc_dataset(dataname = "ADSL", x = ADSL, code = "ADSL <- rcd_2021_07_07$adsl"),
    cdisc_dataset(dataname = "ADLB", x = ADLB, code = "ADLB <- rcd_2021_07_07$adlb")
  ),
  modules = root_modules(
    teal::module(
      "test",
      server = function(input, output, session, datasets) {
      },
      ui = function(id, ...) tags$p("test"),
      filters = "all"
    )
  ),
  header = "Raw App",
  footer = tags$p(class = "text-muted", "Source: agile-R website")
)
safeBookmarkableShinyApp(app$ui, app$server, enableBookmarking = "url")
```

## App with Independent and Non-Independent Data

This app shows how to incorporate independent data like `iris` and `mtcars` alongside some `CDISC` datasets.

```{r independentDependentData, eval=FALSE}
# construct a unique primary key
iris_d <- iris
iris_d["rowname"] <- rownames(iris)
mtcars_d <- mtcars
mtcars_d["rowname"] <- rownames(mtcars)

app <- init(
  data = teal_data(
    cdisc_dataset(dataname = "ADSL", x = ADSL),
    cdisc_dataset(dataname = "ADLB", x = ADLB),
    dataset("iris", iris_d, "rowname"),
    dataset("mtcars", mtcars_d, "rowname")
  ),
  modules = root_modules(
    teal::module(
      "test",
      server = function(input, output, session, datasets) {
      },
      ui = function(id, ...) tags$p("test"),
      filters = "all"
    )
  ),
  header = "Mixed Independent and Dependent Data",
  footer = tags$p(class = "text-muted", "Source: agile-R website")
)
safeBookmarkableShinyApp(app$ui, app$server, enableBookmarking = "url")
```
