---
title: "Adding Support for Reporting to Custom Modules"
author: "NEST CoreDev"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Adding Support for Reporting to Custom Modules}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction

The `teal` package offers an integrated reporting feature utilizing the `teal.reporter` package.
For a comprehensive explanation of the reporting functionality itself, please refer to the documentation therein.

This article is intended for module developers and aims to provide guidance on enhancing a custom `teal` module with an automatic reporting feature.
This enhancement enables users to incorporate snapshots of the module outputs into a report, which can be viewed in another module called `Reporter previewer` (automatically provided by `teal`).
Thus the app user can interact with the report.

The responsibilities of a module developer include:

- Adding support for reporting to their module, by returning a reactive `teal_data` object from the module's `server` function.
- Specifying the outputs that constitute a snapshot of their module.

The entire life cycle of objects involved in creating the report and configuring the module to preview the report is handled by `teal`.

## Add support for reporting

To inform `teal` that the module requires reporting, return a `reactive` containing `teal_report` from the `server` function.
Current outputs of the modules and reproducible code will be included in the module when "add to report" button is clicked.

Every input `teal_data` object in `teal` gets converted to a `teal_report` object, which you can then enhance with additional content.

For detailed information about the `teal_report` class and its capabilities, see the [teal_report Class vignette](https://insightsengineering.github.io/teal.reporter/latest-tag/articles/teal-report-class.html).

## Example

Below is an example demonstrating how to build a `teal` module with reporting functionality.

The key aspects of this implementation are:

1. **Return a reactive `teal_report`**: The module's server function returns a reactive containing an enhanced `teal_report` object
2. **Add content with `teal_card()`**: Commentary and section headers are added using `teal_card()`
3. **Capture computations with `eval_code()`**: Code execution and results are captured for reproducibility

```{r app_5}
library(teal)
library(teal.reporter)

tm_simple_regression <- function(label = "Simple Regression") {
  module(
    label = label,
    server = function(input, output, session, data, reporter, ...) {
      
      output$plot <- renderPlot({
        req(input$x_var, input$y_var)
        dataset <- data()[["iris"]]
        plot(dataset[[input$x_var]], dataset[[input$y_var]])
      })
      
      report_data <- reactive({
        obj <- data()
        teal_card(obj) <- 
          c(teal_card(obj), "# Module's computation")
        eval_code(
          obj, 
          sprintf(
            "correlation <- cor(iris[['%s']], iris[['%s']]);correlation", 
            input$x_var, 
            input$y_var
          ),
          keep_output = TRUE
        )
      })
      report_data
    },
    
    ui = function(id) {
      ns <- NS(id)
      fluidPage(
        h3("Simple Regression Plot"),
        fluidRow(
          column(6,
            selectInput(ns("x_var"), "X Variable:", 
                       choices = names(iris)[1:4], selected = "Sepal.Length")
          ),
          column(6,
            selectInput(ns("y_var"), "Y Variable:", 
                       choices = names(iris)[1:4], selected = "Sepal.Width")
          )
        ),
        plotOutput(ns("plot"))
      )
    }
  )
}

app <- init(
  data = teal_data(iris = iris),
  modules = modules(
    tm_simple_regression("Regression Analysis")
  ),
  header = "Simple Teal App with Reporting"
)

if (interactive()) {
  shinyApp(app$ui, app$server)
}
```

```{r shinylive_iframe_5, echo = FALSE, out.width = '150%', out.extra = 'style = "position: relative; z-index:1"', eval = requireNamespace("roxy.shinylive", quietly = TRUE) && knitr::is_html_output() && identical(Sys.getenv("IN_PKGDOWN"), "true")}
code <- paste0(c(
  knitr::knit_code$get("as_interactive"),
  knitr::knit_code$get("module_1"),
  knitr::knit_code$get("module_5"),
  knitr::knit_code$get("app_5")
), collapse = "\n")

url <- roxy.shinylive::create_shinylive_url(code)
knitr::include_url(url, height = "800px")
```
