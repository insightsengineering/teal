---
title: "Adding support for Reporting to custom modules"
author: "NEST Core Dev Team"
date: "2022-05-23"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Adding support for Reporting to custom modules}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Introduction
`teal` supports an in-built reporting feature using the `vignette("teal.reporter")` package. Head to its documentation
if you want to know more about the reporting itself.

This article explains how to enhance a custom `teal` module with an automatic reporting feature. The enhancement
allows users to add snapshots of the module outputs to a report and review it in another module that is automatically
provided by `teal` and designed to let users interact with the report.

The responsibilities of a module developer include: adding the support for reporting to their module and specifying
outputs that go into a snapshot of their module. The lifecycle of objects involved in creation of the report and
setting up the module to preview the report is handled by `teal`.

## Custom module
Let us consider the example module from `teal`:
```{r}
library(teal)
teal_example_module <- function(label = "example teal module") {
  checkmate::assert_string(label)
  module(
    label,
    server = function(id, datasets) {
      moduleServer(id, function(input, output, session) {
        output$text <- renderPrint(datasets$get_data(input$dataname, filtered = TRUE))
      })
    },
    ui = function(id, datasets) {
      ns <- NS(id)
      teal.widgets::standard_layout(
        output = verbatimTextOutput(ns("text")),
        encoding = selectInput(ns("dataname"), "Choose a dataset", choices = datasets$datanames())
      )
    },
    filters = "all"
  )
}
```

`teal` can launch this example module with the following lines:
```{r}
app <- init(
  data = teal_data(
    dataset("IRIS", iris),
    dataset("MTCARS", mtcars)
  ),
  modules = modules(teal_example_module())
)

if (interactive()) shinyApp(app$ui, app$server)
```

## Add support for Reporting
### Change the declaration of the server function
The first step is to add another argument to the server function declaration - `reporter`. This needs to be the third
argument to the server function inside the `teal.module` call. See below:
```{r}
example_module_with_reporting <- function(label = "example teal module") {
  checkmate::assert_string(label)
  module(
    label,
    server = function(id, datasets, reporter) {
      moduleServer(id, function(input, output, session) {
        output$text <- renderPrint(datasets$get_data(input$dataname, filtered = TRUE))
      })
    },
    ui = function(id, datasets) {
      ns <- NS(id)
      teal.widgets::standard_layout(
        output = verbatimTextOutput(ns("text")),
        encoding = selectInput(ns("dataname"), "Choose a dataset", choices = datasets$datanames())
      )
    },
    filters = "all"
  )
}
```

Such a module is ready to be launched again by `teal`:
```{r}
app <- init(
  data = teal_data(
    dataset("IRIS", iris),
    dataset("MTCARS", mtcars)
  ),
  modules = modules(example_module_with_reporting())
)

if (interactive()) shinyApp(app$ui, app$server)
```

`teal` added another tab to the application titled `Report previer` but besides that there appears to be no change in
how the module works and what it looks like. User cannot interact with it to add to the report from this module yet.
Thankfully, `teal.report` provides `ui` and `server` objects that support that.

### Introduce the new `UI` and the supporting `shiny` modules
We will use `teal.reporter::simple_reporter_ui()` and `teal.reporter::simple_reporter_srv()` to set up the `UI` and
the `shiny` module that allow users to add content from `example_module_with_reporting` to the report.
```{r}
example_module_with_reporting <- function(label = "example teal module") {
  checkmate::assert_string(label)
  module(
    label,
    server = function(id, datasets, reporter) {
      moduleServer(id, function(input, output, session) {
        teal.reporter::simple_reporter_srv(id = "reporter", reporter = reporter, card_fun = function(card) card)
        output$text <- renderPrint(datasets$get_data(input$dataname, filtered = TRUE))
      })
    },
    ui = function(id, datasets) {
      ns <- NS(id)
      teal.widgets::standard_layout(
        output = tagList(
          teal.reporter::simple_reporter_ui(ns("reporter")),
          verbatimTextOutput(ns("text"))
        ),
        encoding = selectInput(ns("dataname"), "Choose a dataset", choices = datasets$datanames())
      )
    },
    filters = "all"
  )
}
```

This module is ready to be launched:
```{r}
app <- init(
  data = teal_data(
    dataset("IRIS", iris),
    dataset("MTCARS", mtcars)
  ),
  modules = modules(example_module_with_reporting())
)

if (interactive()) shinyApp(app$ui, app$server)
```

The new `UI` is visible and the buttons are clickable, but the application does not do anything when clicking the
`Add Card` button because our module does not add any content to the card.

### Add content to the card
We will use the public API exposed by the `teal.reporter::ReportCard` and `teal.reporter::TealReportCard` classes
to add content to a card. The `teal.reporter::simple_reporter_srv` module accepts the `card_fun` argument that
dictates the way the output from our custom module will look like. `ReportCard` and its derivatives adds
the content sequentially according to the order of the calls to its methods. The content itself can be explored
by calling the `$get_content()` method. If you want to learn more, check out `teal.reporter::ReportCard`'s
documentation.

We will add simple text to the card by modifying the `card_fun` argument passed to `teal.reporter::simple_reporter_srv`.
Make sure to return the `card` object from the passed function, otherwise `teal` might encounter errors.
```{r}
example_module_with_reporting <- function(label = "example teal module") {
  checkmate::assert_string(label)
  module(
    label,
    server = function(id, datasets, reporter) {
      moduleServer(id, function(input, output, session) {
        custom_function <- function(card = teal.reporter::ReportCard$new()) {
          card$append_text("This is content from a custom teal module!")
          card
        }
        teal.reporter::simple_reporter_srv(id = "simpleReporter", reporter = reporter, card_fun = custom_function)
        output$text <- renderPrint(datasets$get_data(input$dataname, filtered = TRUE))
      })
    },
    ui = function(id, datasets) {
      ns <- NS(id)
      teal.widgets::standard_layout(
        output = tagList(
          teal.reporter::simple_reporter_ui(ns("simpleReporter")),
          verbatimTextOutput(ns("text"))
        ),
        encoding = selectInput(ns("dataname"), "Choose a dataset", choices = datasets$datanames())
      )
    },
    filters = "all"
  )
}
```

```{r}
app <- init(
  data = teal_data(
    dataset("IRIS", iris),
    dataset("MTCARS", mtcars)
  ),
  modules = modules(example_module_with_reporting())
)

if (interactive()) shinyApp(app$ui, app$server)
```

### Add non-text content to the card
Explore the API of `teal.reporter::ReportCard` to learn what types of content are supported.

### `TealReportCard`
`teal.reporter` exports a `teal`-specific `ReportCard` class that has a number of convenience methods built into it
to make working with `teal` objects like the filter panel or source code easier. Check out its documentation to learn
more at `teal.reporter::TealReportCard`.

To support `TealReportCard`, the function that is passed to `teal.reporter::simple_reporter_srv()` needs to define
a default value for the card, like below:
```{r}
custom_fun <- function(card = teal.reporter::TealReportCard$new()) {
  card
}
```

Otherwise, the API of `TealReportCard` will not be available inside the function.

### Use a child class of `ReportCard` inside the module
`teal.reporter` allows using a child of `ReportCard` inside the function passed to
`teal.reporter::simple_reporter_srv()`. To properly support this, an instance of the child class must be passed
as the default value of the `card` argument in the function passed to `teal.reporter::simple_reporter_srv()`. See
below:
```{r}
CustomReportCard <- R6::R6Class(
  classname = "CustomReportCard",
  inheit = teal.reporter::ReportCard
)

custom_function <- function(card = CustomReportCard$new()) {
  card
}
```
