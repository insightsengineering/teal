<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teal Design and Implementation • teal</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Teal Design and Implementation">
<meta property="og:description" content="teal">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">teal</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/delayed_data_loading.html">Delayed Data Loading</a>
    </li>
    <li>
      <a href="../articles/developer_apps.html">Developer Apps</a>
    </li>
    <li>
      <a href="../articles/getting_started.html">Getting Started with Teal</a>
    </li>
    <li>
      <a href="../articles/teal_desiderata.html">Teal Desiderata</a>
    </li>
    <li>
      <a href="../articles/teal_design_and_implementation.html">Teal Design and Implementation</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<!-- start_releases -->
<li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
Other releases
<span class="caret"></span></a><ul class="dropdown-menu" role="menu">
   <li><a href="../../index.html">latest</a></li>
   <li><a href="../../pre-release/index.html">pre-release</a></li>
   <li><a href="../../v0.10.0/index.html">v0.10.0</a></li>
   <li><a href="../../v0.9.5/index.html">v0.9.5</a></li>
   <li><a href="../../v0.9.4/index.html">v0.9.4</a></li>
   <li><a href="../../v0.9.3/index.html">v0.9.3</a></li>
   <li><a href="../../v0.9.2/index.html">v0.9.2</a></li>
   <li><a href="../../v0.9.1/index.html">v0.9.1</a></li>
   <li><a href="../../v0.9.0/index.html">v0.9.0</a></li>
   <li><a href="../../v0.8.5/index.html">v0.8.5</a></li>
   <li><a href="../../v0.8.4/index.html">v0.8.4</a></li>
   <li><a href="../../v0.8.3/index.html">v0.8.3</a></li>
   <li><a href="../../v0.8.2/index.html">v0.8.2</a></li>
   <li><a href="../../v0.7.0/index.html">v0.7.0</a></li>
   <li><a href="../../v0.6.0/index.html">v0.6.0</a></li>
   <li><a href="../../v0.0.5/index.html">v0.0.5</a></li>
   <li><a href="../../v0.0.4/index.html">v0.0.4</a></li>
   <li><a href="../../v0.0.3/index.html">v0.0.3</a></li>
   <li><a href="../../v0.0.2/index.html">v0.0.2</a></li>
   <li><a href="../../v0.0.1/index.html">v0.0.1</a></li>
</ul></li>
<!-- end_releases -->
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.roche.com/NEST/teal">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><link href="teal_design_and_implementation_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="teal_design_and_implementation_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Teal Design and Implementation</h1>
                        <h4 class="author">Adrian Waddell</h4>
            
            <h4 class="date">10/29/2017</h4>
      
      
      <div class="hidden name"><code>teal_design_and_implementation.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette describes the core design of <code>teal</code> and explains some of <code>teal</code>s implementation details.</p>
<p><code>teal</code> is a framework built on top of <code>shiny</code> that adds</p>
<ul>
<li>data filtering: on a variable basis combined with <code><a href="https://rdrr.io/r/base/Logic.html">&amp;</a></code> logic</li>
<li>API to request the underlying R code of an output</li>
<li>modularized approach to build customized web-apps with <code>teal</code>-modules</li>
</ul>
<p><code>teal</code> modules are <code>shiny</code> modules with an additional <code>datasets</code> argument for the <code>server</code> function that provides an access to the filtered data.</p>
</div>
<div id="shiny-basics" class="section level1">
<h1 class="hasAnchor">
<a href="#shiny-basics" class="anchor"></a>Shiny Basics</h1>
<p>Shiny apps have the following two main components: the <code>server</code> function and an <code>ui</code> object. The <code>ui</code> object is a representation of the <code>html</code> for the webpage and the <code>server</code> function provides the logic to modify the html code. Hence, a minimal shiny app with no server logic is as follows:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">shiny</span>)
<span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/shinyApp.html">shinyApp</a></span>(
  <span class="kw">ui</span> <span class="kw">=</span> <span class="no">tags</span>$<span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/builder.html">p</a></span>(<span class="st">"Hello World"</span>),
  <span class="kw">server</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">input</span>, <span class="no">output</span>, <span class="no">session</span>) {}
)</pre></body></html></div>
<p>You can paste this code to the <code>R</code> command line which will initialize the shiny app. <code>shiny</code> provides a <a href="https://shiny.rstudio.com/articles/reactivity-overview.html">reactivity programming model</a> to update and get information from the ui:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/shinyApp.html">shinyApp</a></span>(
  <span class="kw">ui</span> <span class="kw">=</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/fluidPage.html">fluidPage</a></span>(
    <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/selectInput.html">selectInput</a></span>(<span class="kw">inputId</span> <span class="kw">=</span> <span class="st">"select_data"</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="st">"select data"</span>, <span class="kw">choices</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"iris"</span>, <span class="st">"mtcars"</span>)),
    <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/plotOutput.html">plotOutput</a></span>(<span class="kw">outputId</span> <span class="kw">=</span> <span class="st">"scatterplotmatrix"</span>)
  ),
  <span class="kw">server</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">input</span>, <span class="no">output</span>, <span class="no">session</span>) {
    <span class="no">output</span>$<span class="no">scatterplotmatrix</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/renderPlot.html">renderPlot</a></span>({
      <span class="no">data</span> <span class="kw">&lt;-</span> <span class="no">input</span>$<span class="no">select_data</span>
      <span class="kw">if</span> (<span class="no">data</span> <span class="kw">==</span> <span class="st">"iris"</span>) {
        <span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span>(<span class="no">iris</span>[,-<span class="fl">5</span>], <span class="kw">col</span> <span class="kw">=</span> <span class="no">iris</span>$<span class="no">Species</span>)
      } <span class="kw">else</span> {
        <span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span>(<span class="no">mtcars</span>[, -<span class="fl">2</span>], <span class="kw">col</span> <span class="kw">=</span> <span class="no">mtcars</span>$<span class="no">cyl</span>)
      }
    })
  }
)</pre></body></html></div>
<p>Note that reactivity is used on the server side for capturing the input (i.e. <code>input$select_data</code>) and to update the output (i.e. <code>output$scatterplot</code>). On the ui side shiny keeps the <code>html</code> code up-to-date and propagates user interface input changes to the reactive environment on the server side. Please inspect the <code>html</code> code from the previous example app while the app is running with Chrome’s developer tools and then stop the shiny app and compare that html code with the ui code created by running the following code in the R console:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/fluidPage.html">fluidPage</a></span>(
  <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/selectInput.html">selectInput</a></span>(<span class="kw">inputId</span> <span class="kw">=</span> <span class="st">"select_data"</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="st">"select data"</span>, <span class="kw">choices</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"iris"</span>, <span class="st">"mtcars"</span>)),
  <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/plotOutput.html">plotOutput</a></span>(<span class="kw">outputId</span> <span class="kw">=</span> <span class="st">"scatterplotmatrix"</span>)
)</pre></body></html></div>
<p><a href="https://shiny.rstudio.com/articles/modules.html">Shiny modules</a> provide an elegant way to split both the <em>ui</em> object and <em>server</em> function into reusable and self-contained functions. Please read the <a href="https://shiny.rstudio.com/articles/modules.html">official tutorial</a> and note that input and output elements are separated by using namespaces. For the above example, we can modularize the selection and the plotting of the data as follows:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">ui_example</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">id</span>) {
  <span class="no">ns</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/NS.html">NS</a></span>(<span class="no">id</span>)
  <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/tag.html">tagList</a></span>(
    <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/selectInput.html">selectInput</a></span>(<span class="kw">inputId</span> <span class="kw">=</span> <span class="fu">ns</span>(<span class="st">"select_data"</span>), <span class="kw">label</span> <span class="kw">=</span> <span class="st">"select data"</span>, <span class="kw">choices</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"iris"</span>, <span class="st">"mtcars"</span>)),
    <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/plotOutput.html">plotOutput</a></span>(<span class="kw">outputId</span> <span class="kw">=</span> <span class="fu">ns</span>(<span class="st">"scatterplotmatrix"</span>))
  )
}

<span class="no">srv_example</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">input</span>, <span class="no">output</span>, <span class="no">session</span>) {
  <span class="no">output</span>$<span class="no">scatterplotmatrix</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/renderPlot.html">renderPlot</a></span>({
    <span class="no">data</span> <span class="kw">&lt;-</span> <span class="no">input</span>$<span class="no">select_data</span>
    <span class="kw">if</span> (<span class="no">data</span> <span class="kw">==</span> <span class="st">"iris"</span>) {
      <span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span>(<span class="no">iris</span>[,-<span class="fl">5</span>], <span class="kw">col</span> <span class="kw">=</span> <span class="no">iris</span>$<span class="no">Species</span>)
    } <span class="kw">else</span> {
      <span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html">pairs</a></span>(<span class="no">mtcars</span>[, -<span class="fl">2</span>], <span class="kw">col</span> <span class="kw">=</span> <span class="no">mtcars</span>$<span class="no">cyl</span>)
    }
  })
}</pre></body></html></div>
<p>Note that <code>ui_example</code> and <code>srv_example</code> functions constitute our <em>example</em> module. To use this module twice in an app run the following code:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/shinyApp.html">shinyApp</a></span>(
  <span class="kw">ui</span> <span class="kw">=</span> <span class="kw">function</span>() {
    <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/tag.html">tagList</a></span>(
      <span class="fu">ui_example</span>(<span class="kw">id</span> <span class="kw">=</span> <span class="st">"first"</span>),
      <span class="fu">ui_example</span>(<span class="kw">id</span> <span class="kw">=</span> <span class="st">"second"</span>)
    )
  },
  <span class="kw">server</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">input</span>, <span class="no">output</span>, <span class="no">session</span>) {
    <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/callModule.html">callModule</a></span>(<span class="no">srv_example</span>, <span class="kw">id</span> <span class="kw">=</span> <span class="st">"first"</span>)
    <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/callModule.html">callModule</a></span>(<span class="no">srv_example</span>, <span class="kw">id</span> <span class="kw">=</span> <span class="st">"second"</span>)
  }
)</pre></body></html></div>
<p>Note that because of the namespace <code>id</code> the two modules do not conflict with their <code>html</code> ids and reactivity names. Please inspect the <code>html</code> code for the above example and pay attention to the <code>html</code> <code>id</code> attributes.</p>
<p>Here is a visual representation of this modularization:</p>
<p><img src="images/design_shiny_module.png" width="356"></p>
<p>This modularized construction of shiny apps is one of the foundations of <code>teal</code>. Modularizing code also makes it easier to build a company wide standard for creating and sharing shiny code and also for creating project specific applications quickly.</p>
<p>Finally, the user interface layout is based on <a href="http://bootstrapdocs.com/v3.0.3/docs/">Bootstrap 3</a> when using the <code>fluidPage</code> and <code>fixedPage</code> layout functions (which we do for <code>teal</code>). Understanding the bootstrap framework for layout, class and css association is useful for creating clean user interfaces.</p>
</div>
<div id="the-teal-overall-design" class="section level1">
<h1 class="hasAnchor">
<a href="#the-teal-overall-design" class="anchor"></a>The Teal Overall Design</h1>
<p>The general <code>teal</code> workflow is as follows:</p>
<ol style="list-style-type: decimal">
<li><p>pass a collection of data sets and a collection of configured teal modules to the <code><a href="../reference/init.html">teal::init</a></code> function.</p></li>
<li><p><code><a href="../reference/init.html">teal::init</a></code> composes the <code>ui</code> and <code>server</code> functions that can then be passed to the <code><a href="https://shiny.rstudio.com/reference/shiny/latest/shinyApp.html">shiny::shinyApp</a></code> function</p></li>
</ol>
<p><img src="images/design_use_teal.png" width="676"></p>
<p>A simple example for a completely custom <code>teal</code> module is the following</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">teal</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">magrittr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)

<span class="no">app</span> <span class="kw">&lt;-</span> <span class="kw pkg">teal</span><span class="kw ns">::</span><span class="fu"><a href="../reference/init.html">init</a></span>(
  <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cdisc_data.html">cdisc_data</a></span>(<span class="fu"><a href="../reference/cdisc_dataset.html">cdisc_dataset</a></span>(<span class="st">"ADSL"</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">iris</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">USUBJID</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span>(), <span class="kw">STUDYID</span> <span class="kw">=</span> <span class="st">"A"</span>))),
  <span class="kw">modules</span> <span class="kw">=</span> <span class="fu"><a href="../reference/root_modules.html">root_modules</a></span>(
    <span class="fu"><a href="../reference/module.html">module</a></span>(
      <span class="kw">label</span> <span class="kw">=</span> <span class="st">"sample module"</span>,
      <span class="kw">server</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">input</span>, <span class="no">output</span>, <span class="no">session</span>, <span class="no">datasets</span>) {
        <span class="no">output</span>$<span class="no">scatterplot</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/renderPlot.html">renderPlot</a></span>({
          <span class="no">iris</span> <span class="kw">&lt;-</span> <span class="no">datasets</span>$<span class="fu">get_data</span>(<span class="st">"ADSL"</span>, <span class="kw">filtered</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
          <span class="fu"><a href="https://rdrr.io/r/base/with.html">with</a></span>(<span class="no">iris</span>, <span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">Sepal.Length</span>, <span class="no">Sepal.Width</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="no">Species</span>))
        })
      },
      <span class="kw">ui</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">id</span>, <span class="no">datasets</span>) {
        <span class="no">ns</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/NS.html">NS</a></span>(<span class="no">id</span>)
        <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/plotOutput.html">plotOutput</a></span>(<span class="fu">ns</span>(<span class="st">"scatterplot"</span>))
      },
      <span class="kw">filters</span> <span class="kw">=</span> <span class="st">"ADSL"</span>
    )
  )
)
<span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/shinyApp.html">shinyApp</a></span>(<span class="no">app</span>$<span class="no">ui</span>, <span class="no">app</span>$<span class="no">server</span>)</pre></body></html></div>
<p>Please run the above code by copy pasting it to the command line. The example shows how simple it is to create a module that has no dynamic encodings but still is interactive due to the possibility of filtering the data. The example also highlights a current issue where we require a dataset with the name <code>ADSL</code> that has the variables <code>USUBJID</code> and <code>SUBJID</code>. We describe the reason and the future refactoring needed to overcome this later in this document.</p>
<p>The default <code>teal</code> web application has the following components</p>
<p><img src="images/teal_containers.png" width="350"></p>
<p>and the composition of the shiny app <code>ui</code> object is based on the [<code>tabsetPanel</code>] and the composition of the <code>server</code> function is based on the modules as illustrated here:</p>
<p><img src="images/design_teal.png" width="264"></p>
<p>The important new parts in the above diagram are:</p>
<ul>
<li><p>the <code>datasets</code> object that filters the analysis data and provides an interface to access and modify the data and variable based filtering. The <code>datasets</code> object is of class <code>FilteredData</code> which uses the <a href="https://cran.r-project.org/web/packages/R6/vignettes/Introduction.html"><code>R6</code></a> object system.</p></li>
<li><p>Filter panel related code: that is, a view and controller for the <code>FiltereData</code> object.</p></li>
<li><p>shiny’s [<code>tabsetPanel</code>] for displaying only one analysis module at a time ( e.g. the one with a bold outline). The modules that are not active (visible) get the attribute <code>class=invisible</code> in the html code. Note that the <code>html</code> for each module is always present in your app ui <code>html</code> code.</p></li>
</ul>
<p>These have been the three main challenges (in addition to code reproducibility) when designing and implementing <code>teal</code>. The relevant R-code for these main parts are in the <a href="https://github.roche.com/NEST/teal">teal repository</a> in the following files:</p>
<ul>
<li><code>R/FilteredData.R</code></li>
<li>
<code>R/init.R</code>, <code>R/module_filter_items.R</code>, <code>R/module_add_filter_variables.R</code>
</li>
<li><code>R/init.R</code></li>
</ul>
<p>We have also a logging facility with the <code>.log</code> function with the corresponding code saved in <code>R/logging.R</code>. Logging to the prompt can be disabled with <code><a href="https://rdrr.io/r/base/options.html">options(teal_logging = FALSE)</a></code>.</p>
<p>We now discuss each of the three core components in detail. This would be a good time to browse through the just mentioned <code>.R</code> files and see how much of what has just been said/written can be spotted in the code without further explanation.</p>
<div id="filtereddata" class="section level2">
<h2 class="hasAnchor">
<a href="#filtereddata" class="anchor"></a>FilteredData</h2>
<p>The <code>FilteredData</code> class is an <a href="https://cran.r-project.org/web/packages/R6/vignettes/Introduction.html"><code>R6</code></a> reference class to handle the datasets and the filtering state. In general, every dataset can be filtered based on values of its variables.</p>
<ul>
<li><p>if a variable <code>xi</code> is continuous then the filtering is based on a range: <code>xi in [a,b]</code> where <code>min(xi)&lt;=a&lt;b&lt;=max(xi)</code></p></li>
<li><p>if a variable <code>xi</code> is categorical then the filtering is based on a set: <code>xi in A</code> where <code>A</code> is a subset of the elements in <code>xi</code>.</p></li>
</ul>
<p>When filtering a dataset, say <code>ADSL</code>, with <code>10</code> of its variables then the <code>10</code> subsetting conditions are combined with an logical AND (<code><a href="https://rdrr.io/r/base/Logic.html">&amp;</a></code>). If a more complicated subsetting is needed then it is easiest to add a new variable to the analysis dataset that contains the desired logic which then in turn can be combined via <code><a href="https://rdrr.io/r/base/Logic.html">&amp;</a></code> logic with other variable based subsetting conditions.</p>
<div id="clinical-trials-data" class="section level3">
<h3 class="hasAnchor">
<a href="#clinical-trials-data" class="anchor"></a>Clinical Trials Data</h3>
<p>In order to understand the current implementation of the <code>FilteredData</code> class it is useful to have some background of the data standards used in clinical trials.</p>
<p>For clinical trials the datasets are standardized following the <a href="https://www.cdisc.org">CDISC</a> standards <a href="https://www.cdisc.org/standards/foundational/sdtm">SDTM</a> and <a href="https://www.cdisc.org/standards/foundational/adam">ADaM</a>. Both SDTM and ADaM are based on rectangular data structures and a simplified generalization is that SDTM contains observed raw data and ADaM adds meta data and derives new data so that an output (table/graph) can be computed directly from a single ADaM data set. Here is a diagram of some SDTM datasets:</p>
<p><img src="images/sdtm_overview.png" width="80%"></p>
<p>The names of ADaM datasets often prefix a <code>AD</code> or <code>A</code> to their corresponding <code>SDTM</code> dataset names.</p>
<p>There is one particularly important dataset called <code>ASL</code> or <code>ADLS</code> that contains patient information (e.g. Unique Subject Identifier <code>USUBJID</code>, <code>ARM</code>, <code>SEX</code>, <code>Age</code>, randomization date, etc.) with one row per patient. Often this dataset is merged to all other <code>ADaM</code> datasets as its information is frequently used for most outputs (e.g. <code>ARM</code>). The key for merging <code>ADSL</code> and any other analysis dataset is the <code>USUBJID</code> and <code>STUDYID</code> variable (if not specified otherwise).</p>
</div>
<div id="filtereddata-class-for-clinical-trials-data" class="section level3">
<h3 class="hasAnchor">
<a href="#filtereddata-class-for-clinical-trials-data" class="anchor"></a>FilteredData Class for Clinical Trials Data</h3>
<p>Because of the central role of the <code>ADSL</code> dataset and due to tight project delivery timelines I have unfortunately implemented a filtering mechanism that always depends on <code>ADSL</code> as illustrated here:</p>
<p><img src="images/design_cdisc_filtered_datasets.png" width="100%"></p>
<p>This filtering will now be explained step by step for two example datasets (<code>ADSL</code> and <code>ATE</code>):</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># for reproducibility</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1</span>)

<span class="no">ADSL</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">USUBJID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"id-"</span>, <span class="fl">1</span>:<span class="fl">100</span>),
  <span class="kw">STUDYID</span> <span class="kw">=</span> <span class="st">"studyA"</span>,
  <span class="kw">AGE</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">100</span>, <span class="kw">sd</span> <span class="kw">=</span> <span class="fl">20</span>) + <span class="fl">40</span>),
  <span class="kw">SEX</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'M'</span>, <span class="st">'F'</span>), <span class="fl">100</span>, <span class="fl">TRUE</span>),
  <span class="kw">stringsAsFactors</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)

<span class="no">ADTTE</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">USUBJID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"id-"</span>, <span class="fl">1</span>:<span class="fl">100</span>),
  <span class="kw">STUDYID</span> <span class="kw">=</span> <span class="st">"studyA"</span>,
  <span class="kw">AVAL</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html">rexp</a></span>(<span class="fl">100</span>, <span class="kw">rate</span> <span class="kw">=</span> <span class="fl">1</span>/<span class="fl">20</span>)),
  <span class="kw">CNSR</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>), <span class="fl">100</span>, <span class="fl">TRUE</span>),
  <span class="kw">PARAMCD</span> <span class="kw">=</span> <span class="st">"OS"</span>,
  <span class="kw">stringsAsFactors</span> <span class="kw">=</span> <span class="fl">FALSE</span>
)

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">0</span>)</pre></body></html></div>
<p>The <code>datasets</code> object of class <code>FilteredData</code> that is passed an argument to the <code>server</code> function is created by <code>teal</code> as follows:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">teal</span>)</pre></body></html></div>
<pre><code>## 
## You are using teal version 0.9.2</code></pre>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="kw">teal_logging</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">datasets</span> <span class="kw">&lt;-</span> <span class="kw pkg">teal</span><span class="kw ns">:::</span><span class="no"><a href="../reference/FilteredData.html">FilteredData</a></span>$<span class="fu">new</span>()

<span class="co"># the `datasets` object contains reactives</span>
<span class="co"># we activate this option, so we don't need to wrap all reactives in isolate calls</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="kw">shiny.suppressMissingContextError</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="no">ADSL</span>, <span class="st">"keys"</span>) <span class="kw">&lt;-</span> <span class="kw pkg">teal</span><span class="kw ns">::</span><span class="fu"><a href="../reference/get_cdisc_keys.html">get_cdisc_keys</a></span>(<span class="st">"ADSL"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="no">ADTTE</span>, <span class="st">"keys"</span>) <span class="kw">&lt;-</span> <span class="kw pkg">teal</span><span class="kw ns">::</span><span class="fu"><a href="../reference/get_cdisc_keys.html">get_cdisc_keys</a></span>(<span class="st">"ADTTE"</span>)

<span class="no">datasets</span>$<span class="fu">set_data</span>(<span class="st">"ADSL"</span>, <span class="no">ADSL</span>)
<span class="no">datasets</span>$<span class="fu">set_data</span>(<span class="st">"ADTTE"</span>, <span class="no">ADTTE</span>)
<span class="kw pkg">shiny</span><span class="kw ns">:::</span><span class="fu">flushReact</span>() <span class="co"># force evaluation outside of Shiny apps</span></pre></body></html></div>
<p>Note that this code also runs outside of a teal instance. The public methods of the <code>FilteredData</code> class are:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">datasets</span>)</pre></body></html></div>
<pre><code>##  [1] ".__enclos_env__"             "clone"                      
##  [3] "restore_state_from_bookmark" "get_bookmark_state"         
##  [5] "get_data_info"               "print_filter_info"          
##  [7] "print"                       "get_filter_expr"            
##  [9] "get_default_filter_state"    "set_filter_state"           
## [11] "get_filter_state"            "get_filter_type"            
## [13] "get_filter_info"             "get_datalabel"              
## [15] "get_keys"                    "get_variable_labels"        
## [17] "set_data_attr"               "get_data_attr"              
## [19] "set_code"                    "get_code"                   
## [21] "set_data"                    "get_data"                   
## [23] "datanames"                   "initialize"</code></pre>
<p>these public methods are currently a bit too numerous because I initially thought that I can hide the <code>FilteredData</code> instance (i.e. the <code>datasets</code> object) and pass only the reactive filtered datasets to the modules (using argument matching). However that is difficult due to the use of <code>do.call</code> when composing the <code>server</code> function (and time pressure). We can query the <code>datasets</code> object to display the filter options for each variable:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">datasets</span>$<span class="fu">print_filter_info</span>(<span class="st">"ADSL"</span>)</pre></body></html></div>
<pre><code>## ==== ADSL =======================
## USUBJID has filter type choices   : id-1, id-10, id-100, id-11, id-12, ...
##                      \--&gt; selected: 
## STUDYID has filter type choices   : studyA
##                      \--&gt; selected: 
## AGE     has filter type range     : 0.212966082732542 - 88.0323552100955
##                      \--&gt; selected: 
## SEX     has filter type choices   : F, M
##                      \--&gt; selected: 
## ===========================</code></pre>
<div class="sourceCode" id="cb15"><html><body><pre class="r"># for all variables
# datasets$print_filter_info("ADSL", filtered_vars_only = FALSE)</pre></body></html></div>
<p>Now say we want to filter out all the patients except patients with <code>USUBJID</code> equal to <code>id-1</code>, <code>id-2</code>, <code>id-3</code>, or <code>id-4</code>:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">datasets</span>$<span class="fu">set_filter_state</span>(<span class="st">"ADSL"</span>, <span class="kw">state</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">USUBJID</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">choices</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"id-"</span>, <span class="fl">1</span>:<span class="fl">4</span>), <span class="kw">keep_na</span> <span class="kw">=</span> <span class="fl">FALSE</span>)))</pre></body></html></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="co"># or</span>
<span class="kw pkg">teal</span><span class="kw ns">:::</span><span class="fu"><a href="../reference/set_single_filter_state.html">set_single_filter_state</a></span>(<span class="no">datasets</span>, <span class="st">"ADSL"</span>, <span class="st">"USUBJID"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">choices</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"id-"</span>, <span class="fl">1</span>:<span class="fl">4</span>), <span class="kw">keep_na</span> <span class="kw">=</span> <span class="fl">FALSE</span>))</pre></body></html></div>
<pre><code>## [1] FALSE</code></pre>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="kw pkg">shiny</span><span class="kw ns">:::</span><span class="fu">flushReact</span>()

<span class="no">datasets</span>$<span class="fu">get_data</span>(<span class="st">"ADSL"</span>, <span class="kw">filtered</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<pre><code>##   USUBJID STUDYID      AGE SEX
## 1    id-1  studyA 27.47092   F
## 2    id-2  studyA 43.67287   F
## 3    id-3  studyA 23.28743   M
## 4    id-4  studyA 71.90562   F</code></pre>
<p>Note that this <code>USUBJID</code> variable based filtering also filters the <code>ATE</code> data (with an inner join based on <code>USUBJID</code> and <code>STUDYID</code>), as illustrated in the previous figure:</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">datasets</span>$<span class="fu">get_data</span>(<span class="st">"ADTTE"</span>, <span class="kw">filtered</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<pre><code>##   STUDYID USUBJID      AVAL CNSR PARAMCD
## 1  studyA    id-1  6.948489    0      OS
## 2  studyA    id-2 51.943345    0      OS
## 3  studyA    id-3 19.064549    0      OS
## 4  studyA    id-4 35.942001    0      OS</code></pre>
<p>The two <code>get_data</code> method calls return the <code>ADSL_FILTERED</code> and <code>ADTTE_FILTERED</code> data, respectively, as illustrated from the above figure. We can also get the <code>call</code> object that was used for the filtering:</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">datasets</span>$<span class="fu">get_filter_expr</span>(<span class="st">"ADTTE"</span>)</pre></body></html></div>
<pre><code>## {
##     ADTTE_FILTERED_ALONE &lt;- ADTTE
##     ADTTE_FILTERED &lt;- dplyr::inner_join(x = ADSL_FILTERED[, c("STUDYID", 
##     "USUBJID")], y = ADTTE_FILTERED_ALONE, by = c("STUDYID", 
##     "USUBJID"))
## }</code></pre>
<p>Note that when setting <code>reactive = TRUE</code> in the <code>datasets$get_data</code> method then a reactive value with the requested dataset gets returned which can be directly used in the reactive environment of the teal module <code>server</code> functions.</p>
</div>
<div id="needed-generalization-of-filtereddata" class="section level3">
<h3 class="hasAnchor">
<a href="#needed-generalization-of-filtereddata" class="anchor"></a>Needed Generalization of FilteredData</h3>
<p>The CDISC filtering mechanism which we have introduced in the previous section can be abstracted with the following diagram:</p>
<p><img src="images/design_cdisc_filtered_data.png" width="213"></p>
<p>This is, however, a very particular filtering setup that has not much use besides analyzing clinical trials data that follows CDISC standards. A more general filtering setup would be to have variable based filtering for an arbitrary dataset:</p>
<p><img src="images/design_one_dataset_filtered_data.png" width="96"></p>
<p>or more generally a collection of independently filtered datasets:</p>
<p><img src="images/design_simple_filtered_data.png" width="204"></p>
<p>Lets call this particular filtering the <code>SimpleFilteredData</code> class.</p>
<p>Finally we would also need a filtering for <a href="https://www.bioconductor.org/packages/3.7/bioc/vignettes/Biobase/inst/doc/ExpressionSetIntroduction.pdf">expression sets</a></p>
<p><img src="images/expressionset.png" width="346"></p>
<p>that is, filtering expression sets is a slightly more advanced filtering as one probably wants to filter the biomarker data on a sample level but also on gene-meta data level (filter columns and rows).</p>
<p>In terms of refactoring <code>teal</code> this means that the <code>FilteredData</code> class needs to become abstract with multiple concrete classes that inherit from <code>FilteredData</code>:</p>
<p><img src="images/design_FilteredData.png" width="476"></p>
</div>
<div id="optimizing-the-filtereddata-class" class="section level3">
<h3 class="hasAnchor">
<a href="#optimizing-the-filtereddata-class" class="anchor"></a>Optimizing The FilteredData Class</h3>
<p>The arrows that point downwards in the filtering related diagrams above indicate a propagation mechanism that happens to be inefficient. That is, when filtering with <code>ADSL</code> variables then all the dependent datasets (that is currently every other dataset) gets updated regardless if there is any output currently displayed that requires the information from a particular dataset. Hence we loose the lazy evaluation that is provided with shiny’s reactivity framework. It would be better to set up the datasets reactive and only have them apply the filtering and merging if there is actually something displayed in the shiny app that requires the particular dataset.</p>
<p><img src="images/design_reactive_filtered_data.png" width="87"></p>
</div>
<div id="summary-of-filtering-related-issues" class="section level3">
<h3 class="hasAnchor">
<a href="#summary-of-filtering-related-issues" class="anchor"></a>Summary of filtering related issues</h3>
<p>First the main issues mentioned above:</p>
<ul>
<li><p>make <code>FilteredData</code> class abstract and implement concrete classes (as outlined above) inheriting from <code>FilteredData</code>.</p></li>
<li><p>make the filtering lazy by making better use of reactivity (using <code><a href="https://shiny.rstudio.com/reference/shiny/latest/reactiveValues.html">reactiveValues()</a></code>).</p></li>
</ul>
<p>Also, a simple feature but still useful improvement is to support:</p>
<ul>
<li>filtering with variables of class <code>Date</code>
</li>
</ul>
</div>
</div>
<div id="composition-of-the-ui-and-server-functions-with-tealinit" class="section level2">
<h2 class="hasAnchor">
<a href="#composition-of-the-ui-and-server-functions-with-tealinit" class="anchor"></a>Composition of the ui and server functions with <code>teal::init</code>
</h2>
<p>In this section we discuss the code in <code>R/init.R</code>. The <code>init</code> function composes the <code>ui</code> object and the <code>server</code> function which are returned and then passed to <code>shinyApp</code> to start the web app.</p>
<p>The datasets passed to the <code>data</code> arguments get encapsulated within the <code>init</code> function into a local instance of <code>FilteredData</code> (i.e. the <code>datasets</code> object).</p>
<p>Next, the <code>ui</code> object is created. The composition of ui and server happens entirely with the object passed via <code>modules</code>, <code>header</code>, and <code>footers</code> arguments. The <code>modules</code> object is a tree of <code><a href="../reference/modules.html">modules()</a></code> (nested lists) with currently a constrained depth of 2. The composition of the ui functions defined in <code>modules</code> happens recursively via the <code>create_ui</code> function. Note that the <code>create_ui</code> function call happens in a local environment as we modify the returned object structure to add the filter panel on the right hand side (this improves the UI as it places the filter panel below the <code>tabsetPanel</code> menu).</p>
<p>There are two major improvement opportunities in creating the ui object:</p>
<ol style="list-style-type: decimal">
<li><p>the ui object should optionally be a <code>ui</code> function so that the whole <code>teal</code> application can be modularized</p></li>
<li><p>the filter panel has not been abstracted and encapsulated nicely enough to be a reusable view/controller for the <code>datasets</code> object (i.e. for the class <code>FilteredData</code>). This currently does not limit the teal functionality. However it has implications for the server function composition as will be illustrated below.</p></li>
</ol>
<p>Also note that the added javascript in the <code>ui</code> object is necessary to manually interrupt reactivity when hiding the ui elements for filtering based on variables that are not relevant for a particular analysis (i.e. we do not show <code>ARS</code> filter variables if we analyse an output based on <code>ATE</code>).</p>
<p>Next: the creation of the server function. The easy part is the composition of the module server functions which happens with the <code>call_modules</code> function call.</p>
<p>The rest of the server function creation related code revolves around the filtered data panel. Again, a nice improvement here would be to</p>
<ul>
<li>make the filter panel a module</li>
</ul>
</div>
<div id="reproducibility" class="section level2">
<h2 class="hasAnchor">
<a href="#reproducibility" class="anchor"></a>Reproducibility</h2>
<p>There are multiple parts to create reproducible code for the displayed outputs:</p>
<ol style="list-style-type: decimal">
<li><p>what <code>R</code> version is used and on which platform</p></li>
<li><p>what libraries are used, and which version</p></li>
<li><p>data used and hash sum (currently on BCE the path is the identifier and the hash sum in needed as the data may change over time)</p></li>
<li><p>subset call to get the filtered data</p></li>
<li><p>code to create the output</p></li>
</ol>
<p>In <code>teal</code> we started to streamline 1) and 2) with the <code>get_rcode_header</code> function. This function needs to be improved but that is a simple exercise. Next, 3) can either be achieved via the <code>get_filter_call</code> method of the <code>datasets</code> object or simpler via the <code>get_filter_txt</code> function. Finally 4) is currently the most difficult to achieve well. We have tried to create the R call (in a string to preserve the formatting) and then evaluating that string to create the output, however that is not a good approach as it makes it essentially impossible to debug the modules. Another approach that we have tried is to use tagging with <code>@start_label</code> and <code>@end_label</code> as documented in the <code>02_reproducible-code</code> vignette. Two more promising approaches are to tag the code chunks via a function call with tag and chunk-code and then remove the function call but leave the code when creating the server function (as proposed by Michael) and another approach is developed by Doug and Gabe.</p>
<p>After having created a number of modules for <a href="https://github.roche.com/NEST/teal.modules.clinical"><code>teal.modules.clinical</code></a> it seems probably easiest to keep the modules simple by making a module to be a user interface for a simple function call with dynamic arguments. E.g. we created am analysis package <a href="https://github.roche.com/NEST/tern">tern</a> which has the function <code>kmplot</code> to create a Kaplan-Meier plot. We have then also created the <a href="https://github.roche.com/NEST/teal.modules.clinical"><code>teal.modules.clinical</code></a> R package which has the module <code>tm_kplot</code> which provides a user interface that allows one to modify certain arguments of <code>tern::kmplot</code> via the encodings panel. This reduces 4) essentially to an argument tracking problem. This is, however, work in progress.</p>
</div>
<div id="desiderata" class="section level2">
<h2 class="hasAnchor">
<a href="#desiderata" class="anchor"></a>Desiderata</h2>
<ul>
<li><p>save the state of an app and provide shareable links that capture the state of the analysis/app</p></li>
<li><p>inheritance model for teal modules, e.g. make slightly modified modules (this needs to be better formulated, e.g. what exactly changes: output arguments, encoding ui/logic, etc…?</p></li>
<li><p><code>teal</code> modules probably need a shared state such as selected arm variable. This could be achieved by a reactive value that is passed as an argument to the modules.</p></li>
</ul>
</div>
</div>
<div id="embed-teal-into-other-applications" class="section level1">
<h1 class="hasAnchor">
<a href="#embed-teal-into-other-applications" class="anchor"></a>Embed teal into other applications</h1>
<p>Here is an example of an app with two independent teal applications side-by-side. The same idea can be used to embed it into other Shiny modules. We use the <code>id</code> argument of the <code>init</code> function for this.</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">random.cdisc.data</span>)

<span class="no">ADSL</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/random.cdisc.data/man/radsl.html">radsl</a></span>(<span class="kw">cached</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span>(<span class="kw">teal_logging</span> <span class="kw">=</span> <span class="fl">FALSE</span>)

<span class="co"># Code to have two teal apps side-by-side or embed it in a larger application</span>
<span class="no">create_teal_app</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">title</span>, <span class="no">id</span>) {
  <span class="fu"><a href="../reference/init.html">init</a></span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cdisc_data.html">cdisc_data</a></span>(
      <span class="fu"><a href="../reference/cdisc_dataset.html">cdisc_dataset</a></span>(<span class="st">"ADSL"</span>, <span class="no">ADSL</span>),
      <span class="kw">code</span> <span class="kw">=</span> <span class="st">"ADSL &lt;- radsl(seed = 1)"</span>
    ),
    <span class="kw">modules</span> <span class="kw">=</span> <span class="fu"><a href="../reference/root_modules.html">root_modules</a></span>(
      <span class="fu"><a href="../reference/module.html">module</a></span>(
        <span class="st">"data source"</span>,
        <span class="kw">server</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">input</span>, <span class="no">output</span>, <span class="no">session</span>, <span class="no">datasets</span>) {},
        <span class="kw">ui</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">id</span>, <span class="no">...</span>) <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/builder.html">div</a></span>(<span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/builder.html">p</a></span>(<span class="st">"information about data source"</span>)),
        <span class="kw">filters</span> <span class="kw">=</span> <span class="st">"all"</span>
      ),
      <span class="fu"><a href="../reference/module.html">module</a></span>(
        <span class="st">"ADSL AGE histogram"</span>,
        <span class="kw">server</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">input</span>, <span class="no">output</span>, <span class="no">session</span>, <span class="no">datasets</span>) {
          <span class="no">output</span>$<span class="no">hist</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/renderPlot.html">renderPlot</a></span>(
            <span class="fu"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(<span class="no">datasets</span>$<span class="fu">get_data</span>(<span class="st">"ADSL"</span>, <span class="kw">filtered</span> <span class="kw">=</span> <span class="fl">TRUE</span>)$<span class="no">AGE</span>)
          )
        },
        <span class="kw">ui</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">id</span>, <span class="no">...</span>) {
          <span class="no">ns</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/NS.html">NS</a></span>(<span class="no">id</span>)
          <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/plotOutput.html">plotOutput</a></span>(<span class="fu">ns</span>(<span class="st">"hist"</span>))
        },
        <span class="kw">filters</span> <span class="kw">=</span> <span class="st">"ADSL"</span>
      )
    ),
    <span class="kw">filter</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">ADSL</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">AGE</span> <span class="kw">=</span> <span class="fu"><a href="../reference/default_filter.html">default_filter</a></span>())),
    <span class="kw">header</span> <span class="kw">=</span> <span class="no">tags</span>$<span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/builder.html">h1</a></span>(<span class="no">title</span>),
    <span class="kw">footer</span> <span class="kw">=</span> <span class="no">tags</span>$<span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/builder.html">p</a></span>(<span class="st">"Copyright 2017 - 2020"</span>),
    <span class="kw">id</span> <span class="kw">=</span> <span class="no">id</span>
  )
}
<span class="no">app1</span> <span class="kw">&lt;-</span> <span class="fu">create_teal_app</span>(<span class="st">"Sample App1"</span>, <span class="kw">id</span> <span class="kw">=</span> <span class="st">"app1"</span>)
<span class="no">app2</span> <span class="kw">&lt;-</span> <span class="fu">create_teal_app</span>(<span class="st">"Sample App2"</span>, <span class="kw">id</span> <span class="kw">=</span> <span class="st">"app2"</span>)
<span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/shinyApp.html">shinyApp</a></span>(<span class="kw">ui</span> <span class="kw">=</span> <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/fluidPage.html">fluidPage</a></span>(
  <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/fluidPage.html">fluidRow</a></span>(
    <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/column.html">column</a></span>(<span class="fl">6</span>, <span class="no">app1</span>$<span class="no">ui</span>),
    <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/column.html">column</a></span>(<span class="fl">6</span>, <span class="no">app2</span>$<span class="no">ui</span>)
  )
), <span class="kw">server</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">input</span>, <span class="no">output</span>, <span class="no">session</span>) {
  <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/callModule.html">callModule</a></span>(<span class="no">app1</span>$<span class="no">server</span>, <span class="st">"app1"</span>)
  <span class="fu"><a href="https://shiny.rstudio.com/reference/shiny/latest/callModule.html">callModule</a></span>(<span class="no">app2</span>$<span class="no">server</span>, <span class="st">"app2"</span>)
})

<span class="co"># However, we recommend to use `ui_teal_with_splash` and `srv_teal_with_splash` if you would</span>
<span class="co"># want to use the teal app in the same way as Shiny modules with `callModule`, `ARGS` needs to</span>
<span class="co"># be filled in:</span>
<span class="co"># app1 &lt;- create_teal_app("Sample App1")</span>
<span class="co"># app2 &lt;- create_teal_app("Sample App2")</span>
<span class="co"># shinyApp(ui = fluidPage(</span>
<span class="co">#   fluidRow(</span>
<span class="co">#     column(6, ui_teal_with_splash("app1", ARGS)),</span>
<span class="co">#     column(6, ui_teal_with_splash("app2", ARGS))</span>
<span class="co">#   )</span>
<span class="co"># ), server = function(input, output, session) {</span>
<span class="co">#   callModule(srv_teal_with_splash, "app1", ARGS)</span>
<span class="co">#   callModule(srv_teal_with_splash, "app2", ARGS)</span>
<span class="co"># })</span></pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by NEST, Adrian Waddell, Pawel Rucki, Dawid Kaledkowski, Sebastian Wolf, Maximilian Mordig, Bartosz Baranowski, Ondrej Slama, Nikolas Burkoff, Maciej Nasinski, Roche.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
